<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ground Trick Spin - v2.2.1 Centered & Fixed</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Dela+Gothic+One&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --mario-red: #e4000f;
            --mario-blue: #049cd8;
            --mario-yellow: #fbd000;
            --mario-green: #43b047;
            --mario-brown: #8d5524;
            --mario-sky: #5c94fc;
            --brick-orange: #f08c3b;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #000;
            color: white;
            image-rendering: pixelated;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 0; 
            overflow-x: hidden;
            overflow-y: auto;
        }

        body.lang-ja {
            font-family: 'Dela Gothic One', cursive;
        }

        * {
            text-shadow: none !important;
            box-shadow: none !important;
            outline: none !important;
            box-sizing: border-box;
        }

        .cabinet {
            background: #5d3a37;
            border: 8px solid #221111;
            padding: 12px;
            width: 100%;
            max-width: 900px;
            border-radius: 0px; 
            min-height: 100vh;  
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 640px) {
            body { padding: 20px; }
            .cabinet { 
                padding: 25px; 
                border-width: 12px; 
                border-radius: 12px;
                min-height: auto; 
            }
        }

        .screen-bezel {
            background: #111;
            padding: 10px;
            border: 4px solid #000;
            border-radius: 10px;
            position: relative;
            z-index: 5;
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            justify-content: center; 
        }

        @media (min-width: 640px) {
            .screen-bezel { padding: 20px; border-width: 8px; }
        }

        .mario-title-text {
            color: #000 !important;
            -webkit-text-stroke: 6px var(--mario-yellow);
            paint-order: stroke fill;
            letter-spacing: 2px;
            line-height: 1.4;
            text-align: center;
            font-weight: 900;
            margin-bottom: 30px;
            display: inline-block;
        }

        #title-main { font-size: 28px; margin-bottom: 20px; }
        body.lang-ja #title-main { font-size: 40px; -webkit-text-stroke: 6px var(--mario-yellow); letter-spacing: 0px; }

        body.lang-ja #label-complete, body.lang-ja #label-ranking {
            font-size: 32px; -webkit-text-stroke: 6px var(--mario-yellow);
        }

        @media (min-width: 640px) {
            #title-main { font-size: 60px; -webkit-text-stroke: 12px var(--mario-yellow); margin-bottom: 40px; }
            body.lang-ja #title-main { font-size: 70px; -webkit-text-stroke: 10px var(--mario-yellow); }
            body.lang-ja #label-complete, body.lang-ja #label-ranking {
                font-size: 60px; -webkit-text-stroke: 10px var(--mario-yellow);
            }
        }

        .btn-arcade {
            background: var(--mario-red);
            border: 6px solid #000;
            color: white;
            padding: 20px 10px;
            width: 100%;
            cursor: pointer;
            font-size: 20px;
            margin-top: 15px;
            position: relative;
            z-index: 10;
        }
        .btn-arcade:active { transform: translateY(6px); }

        .btn-arcade:disabled {
            background: #444 !important;
            color: #888 !important;
            border-color: #222 !important;
            cursor: not-allowed;
            transform: none !important;
        }

        body.lang-ja .btn-arcade { font-size: 24px; padding: 24px 10px; }

        @media (min-width: 640px) {
            .btn-arcade { font-size: 24px; padding: 24px; border-width: 8px; }
            body.lang-ja .btn-arcade { font-size: 36px; padding: 30px 15px; }
        }

        .ver-info-text {
            margin-top: 10px; font-size: 8px; color: rgba(255, 255, 255, 0.4);
            font-family: sans-serif; text-align: center; width: 100%; display: block;
        }

        .btn-lang {
            background: transparent !important; border: none !important;
            color: #fff; padding: 10px 20px; font-size: 20px;
            cursor: pointer; transition: color 0.2s;
        }
        @media (min-width: 640px) { .btn-lang { font-size: 28px; } }
        .btn-lang.active { color: var(--mario-yellow) !important; text-decoration: underline; }

        .top-marquee {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 12px;
            background: #000;
            padding: 8px;
            border: 3px solid var(--mario-brown);
        }

        .mode-box {
            background: #1a1a1a;
            border: 3px solid #444;
            aspect-ratio: 5 / 2; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: #666;
            text-align: center;
            padding: 2px;
        }
        
        body.lang-ja .mode-box { font-size: 14px; font-weight: 900; }

        @media (min-width: 640px) {
            .mode-box { font-size: 16px; border-width: 4px; padding: 6px; }
            body.lang-ja .mode-box { font-size: 26px; }
        }

        .mode-box.active { background: #fff !important; color: #000 !important; z-index: 10; }
        .mode-box.selected-fixed { background: var(--mario-blue) !important; color: #fff !important; border-color: #fff !important; }

        .slot-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 4px; 
            background: #111;
            padding: 4px;
            border: 4px solid #333;
            width: 100%;
        }

        .trick-box {
            aspect-ratio: 1 / 1; 
            min-width: 0;        
            min-height: 0;       
            background: #222;
            border: 2px solid #000;
            border-radius: 4px; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .trick-inner {
            white-space: nowrap; 
            text-align: center;
            color: #fff;
            font-size: 14px; 
            line-height: 1.25;
            padding: 0;
            transform-origin: center center;
            -webkit-font-smoothing: antialiased;
        }

        body.lang-ja .trick-inner { font-size: 16px; line-height: 1.15; font-weight: 900; }

        @media (min-width: 640px) {
            .trick-inner { font-size: 20px; }
            body.lang-ja .trick-inner { font-size: 24px; }
        }

        .box-red { background: #9c0c16; }
        .box-blue { background: #0c6a8f; }
        .box-green { background: #2b782f; }
        .box-yellow { background: var(--mario-yellow); color: #000; }
        .box-yellow .trick-inner { color: #000; } 

        .trick-box.active { background: #fff !important; transform: scale(1.1); border-radius: 6px; z-index: 100; box-shadow: 0 0 10px rgba(255,255,255,0.5) !important; }
        .trick-box.active .trick-inner { color: #000 !important; }
        
        .trick-box.selected-fixed { background: #fff !important; border: 4px solid var(--mario-yellow) !important; }
        .trick-box.selected-fixed .trick-inner { color: #000 !important; }

        .center-screen {
            grid-column: 2 / 9; 
            grid-row: 2 / 6;    
            margin: 6px; 
            background: #000; 
            border: 4px solid #000;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .led-panel {
            font-family: 'Press Start 2P', cursive; background: #000; border: 4px solid #555;
            padding: 8px; color: #fff; text-align: center;
        }
        body.lang-ja .led-panel { font-family: 'Dela Gothic One', cursive; }
        #hud-name { font-size: 12px; min-width: 100px; }
        @media (min-width: 640px) { #hud-name { font-size: 24px; min-width: 200px; } }

        .overlay {
            position: fixed; 
            inset: 0; 
            z-index: 5000; 
            padding: 20px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            overflow-y: auto; 
        }
        .hidden { display: none !important; }

        input, select {
            background: #000 !important; border: 4px solid #fff !important; color: var(--mario-yellow) !important;
            padding: 15px; font-size: 12px; width: 100%; outline: none; margin-bottom: 15px;
            text-align: center; appearance: none; -webkit-appearance: none; border-radius: 0;
        }
        body.lang-ja input, body.lang-ja select { font-size: 18px; }

        .star-rating { display: flex; gap: 10px; margin: 25px 0; z-index: 10; }
        /* Â∞áÁ©∫ÊòüÊòüÁöÑÈ°èËâ≤ÊîπÁÇ∫Ê∑∫ÁÅ∞Ëâ≤Ôºå‰ΩøÂÖ∂Âú®Ê∑±Ëâ≤ËÉåÊôØ‰∏äÊõ¥ÊòéÈ°Ø */
        .star-icon { font-size: 40px; color: #aaa; cursor: pointer; transition: color 0.2s; }
        /* Â¢ûÂä†ÊªëÈº†Êá∏ÂÅúÊôÇËÆäÁôΩËâ≤ÁöÑÊïàÊûú */
        .star-icon:hover { color: #fff; }
        @media (min-width: 640px) { .star-icon { font-size: 60px; } }
        .star-icon.active { color: var(--mario-yellow); }

        .leaderboard { 
            width: 100%; border-collapse: collapse; margin-top: 20px; 
            font-size: 10px; color: #fff; background: rgba(0,0,0,0.9); z-index: 10;
        }
        body.lang-ja .leaderboard { font-size: 14px; }
        @media (min-width: 640px) { body.lang-ja .leaderboard { font-size: 18px; } }
        .leaderboard th, .leaderboard td { border: 2px solid #fff; padding: 10px; text-align: center; }

        .scene-bg { position: absolute; inset: 0; pointer-events: none; z-index: 0; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .float-obj { animation: float 2.5s ease-in-out infinite; }
    </style>
</head>
<body class="lang-en">

    <template id="tpl-home">
        <img src="bg-home.jpg" style="width: 100%; height: 100%; object-fit: cover; object-position: center; filter: brightness(0.4);" onerror="this.style.display='none'"/>
    </template>

    <template id="tpl-rating">
        <img src="bg-result.jpg" style="width: 100%; height: 100%; object-fit: cover; object-position: center; filter: brightness(0.4);" onerror="this.style.display='none'"/>
    </template>

    <template id="tpl-ranking">
        <img src="bg-result.jpg" style="width: 100%; height: 100%; object-fit: cover; object-position: center; filter: brightness(0.4);" onerror="this.style.display='none'"/>
    </template>

    <template id="tpl-turn">
        <img src="bg-turn.jpg" style="width: 100%; height: 100%; object-fit: cover; object-position: center; filter: brightness(0.4);" onerror="this.style.display='none'"/>
    </template>

    <div class="cabinet">
        <div class="flex justify-between mb-3 px-1 items-end">
            <div>
                <p id="label-challenger" class="text-[8px] text-gray-400 mb-1 uppercase font-bold">CHALLENGER</p>
                <div id="hud-name" class="led-panel">---</div>
            </div>
            <div class="text-right">
                <p id="label-round" class="text-[8px] text-gray-400 mb-1 uppercase font-bold">ROUND</p>
                <div id="hud-round" class="led-panel text-yellow-400">0/0</div>
            </div>
        </div>

        <div class="screen-bezel">
            <div class="top-marquee">
                <div id="mode-0" class="mode-box">1 HIT</div>
                <div id="mode-1" class="mode-box">2 COMBO</div>
                <div id="mode-2" class="mode-box">3 COMBO</div>
            </div>

            <div id="slot-grid" class="slot-grid">
                <div class="center-screen">
                    
                    <!-- ËΩâÁõ§‰∏≠ÂøÉÁï´Èù¢ËÉåÊôØ -->
                    <div class="absolute inset-0 z-0">
                        <img src="bg-center.jpg" style="width: 100%; height: 100%; object-fit: cover; object-position: center; filter: brightness(0.5);" onerror="this.style.display='none'"/>
                    </div>
                    
                    <!-- üî• Â∑≤ÁßªÈô§Â∞è‰∫∫Áâ©Ôºå‰∏¶Â∞áÁãÄÊÖãÊ°ÜÂÆåÁæéÁΩÆ‰∏≠‰∏îÊîæÂ§ß -->
                    <div class="relative z-20 w-11/12 flex flex-col items-center justify-center">
                        <div id="status-label" class="text-[10px] md:text-[14px] text-white mb-3 uppercase font-bold tracking-widest" style="text-shadow: 2px 2px 0 #000;">READY?</div>
                        <div class="bg-black/85 border-2 border-white p-4 shadow-2xl w-full rounded-sm">
                            <p id="msg-display" class="text-[12px] md:text-[18px] text-yellow-400 uppercase font-black leading-relaxed">PRESS SPIN</p>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <button id="start-btn" onclick="runSequence()" class="btn-arcade">SPIN START</button>
        <div class="ver-info-text">v2.2.1 Centered & Fixed</div>

        <!-- SETUP OVERLAY -->
        <div id="setup-overlay" class="overlay">
            <div class="scene-bg" id="setup-bg"></div>
            <div class="relative z-10 w-full max-w-lg flex flex-col items-center py-8">
                <div class="flex gap-4 sm:gap-8 mb-6 z-[600] justify-center w-full">
                    <button onclick="changeLang('en')" id="btn-en" class="btn-lang active">ENGLISH</button>
                    <button onclick="changeLang('ja')" id="btn-ja" class="btn-lang">Êó•Êú¨Ë™û</button>
                </div>
                <h1 id="title-main" class="mario-title-text uppercase font-black">GROUND<br>TRICK SPIN</h1>
                
                <div class="w-full px-5">
                    <input type="text" id="p1" placeholder="NAME 1 (REQUIRED)" oninput="checkInputs()">
                    <input type="text" id="p2" placeholder="NAME 2 (OPTIONAL)" oninput="checkInputs()">
                    <input type="text" id="p3" placeholder="NAME 3 (OPTIONAL)" oninput="checkInputs()">
                    <div class="flex items-center justify-between w-full mt-2 bg-black border-4 border-white p-4">
                        <span id="label-rounds-setup" class="text-[10px] text-white uppercase font-bold">ROUNDS:</span>
                        <select id="round-select" class="w-24 text-[12px] !m-0 !p-1 !bg-transparent border-0">
                            <option value="1">1</option><option value="2">2</option>
                            <option value="3" selected>3</option><option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
                <button id="setup-start-btn" disabled onclick="initGame()" class="btn-arcade mt-8 w-11/12 text-[16px]">START CHALLENGE</button>
                <div class="ver-info-text">v2.2.1 Centered & Fixed</div>
            </div>
        </div>

        <!-- RATING OVERLAY -->
        <div id="rating-overlay" class="overlay hidden rating-panel">
            <div class="scene-bg" id="rating-bg"></div>
            <div class="relative z-10 flex flex-col items-center w-full">
                <h3 id="label-complete" class="mario-title-text text-xl uppercase font-bold">TRICK COMPLETE!</h3>
                <p id="rating-text" class="text-white text-center mb-10 uppercase font-black"></p>
                <div class="star-rating">
                    <span class="star-icon" onclick="setStars(1)">‚òÖ</span>
                    <span class="star-icon" onclick="setStars(2)">‚òÖ</span>
                    <span class="star-icon" onclick="setStars(3)">‚òÖ</span>
                    <span class="star-icon" onclick="setStars(4)">‚òÖ</span>
                    <span class="star-icon" onclick="setStars(5)">‚òÖ</span>
                </div>
                <button id="confirm-rating-btn" disabled onclick="saveRating()" class="btn-arcade text-[18px] w-3/4">CONFIRM STARS</button>
                <div class="ver-info-text">v2.2.1 Centered & Fixed</div>
            </div>
        </div>

        <!-- RANKING OVERLAY -->
        <div id="ranking-overlay" class="overlay hidden ranking-panel">
            <div class="scene-bg" id="ranking-bg"></div>
            <div class="relative z-10 flex flex-col items-center w-full max-w-xl">
                <h2 id="label-ranking" class="mario-title-text text-xl uppercase font-black mt-8">FINAL RANKING</h2>
                <div id="rank-container" class="w-full"></div>
                <button id="btn-again" onclick="location.reload()" class="btn-arcade mt-12 text-[14px] w-2/3">PLAY AGAIN</button>
                <div class="ver-info-text">v2.2.1 Centered & Fixed</div>
            </div>
        </div>

        <!-- TURN OVERLAY -->
        <div id="turn-overlay" class="overlay hidden">
            <div class="scene-bg" id="turn-bg"></div>
            <div class="relative z-10 flex flex-col items-center">
                <p id="label-next" class="text-yellow-400 mb-8 text-xl text-center uppercase font-bold">UP NEXT</p>
                <p id="next-name" class="text-4xl text-white mb-16 text-center uppercase font-bold"></p>
                <button id="btn-ready" onclick="closeTurn()" class="btn-arcade text-[18px] w-full">I AM READY!</button>
                <div class="ver-info-text">v2.2.1 Centered & Fixed</div>
            </div>
        </div>
    </div>

    <script>
        const AudioSys = {
            ctx: null, bgmTimer: null,
            init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play(freq, type, duration, vol=0.1) {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type === 'bgm' ? 'triangle' : type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },
            beep() { this.play(880, 'square', 0.1); },
            boop() { this.play(220, 'square', 0.15); },
            coin() { this.play(987, 'square', 0.1); setTimeout(() => this.play(1318, 'square', 0.3), 100); },
            win() { 
                const notes = [523, 659, 783, 1046];
                notes.forEach((f, i) => setTimeout(() => this.play(f, 'square', 0.2), i * 150));
            },
            startMarioTheme() {
                if(this.bgmTimer) return; this.init();
                const theme = [{f:659, d:150}, {f:659, d:150}, {f:0, d:150}, {f:659, d:150}, {f:0, d:150}, {f:523, d:150}, {f:659, d:150}, {f:0, d:150}, {f:783, d:300}, {f:0, d:300}, {f:392, d:300}, {f:0, d:300}];
                let idx = 0;
                const playNext = () => {
                    const note = theme[idx];
                    if(note.f > 0) this.play(note.f, 'bgm', note.d/1000, 0.05);
                    idx = (idx + 1) % theme.length;
                    this.bgmTimer = setTimeout(playNext, note.d);
                };
                playNext();
            }
        };

        const GRID_PATH = [
            {r:1, c:1}, {r:1, c:2}, {r:1, c:3}, {r:1, c:4}, {r:1, c:5}, {r:1, c:6}, {r:1, c:7}, {r:1, c:8}, {r:1, c:9},
            {r:2, c:9}, {r:3, c:9}, {r:4, c:9}, {r:5, c:9},
            {r:6, c:9}, {r:6, c:8}, {r:6, c:7}, {r:6, c:6}, {r:6, c:5}, {r:6, c:4}, {r:6, c:3}, {r:6, c:2}, {r:6, c:1},
            {r:5, c:1}, {r:4, c:1}, {r:3, c:1}, {r:2, c:1}
        ];

        const I18N = {
            en: {
                challenger: "CHALLENGER", round: "ROUND", hits: ["1 HIT", "2 COMBO", "3 COMBO"],
                ready: "READY?", press_spin: "PRESS SPIN", start: "START CHALLENGE",
                complete: "TRICK COMPLETE!", confirm: "CONFIRM STARS", ranking: "FINAL RANKING",
                again: "PLAY AGAIN", next: "UP NEXT", ready_btn: "I AM READY!", rounds_label: "ROUNDS:",
                spin_btn: "SPIN START", status_spin: "MODE SPIN...", status_roll: "ROLLING", status_finish: "FINISH!",
                tricks: [
                    "FS<br>Nollie 3", "FS<br>Nollie 5", "BS<br>Nollie 3", "BS<br>Nollie 5",
                    "FS Nollie<br>Comp 3", "FS Nollie<br>Comp 5", "BS Nollie<br>Comp 3", "BS Nollie<br>Comp 5",
                    "Drive<br>Spin 5", "Owen", "Tochi", "Andy 3", "Andy 5", "Sashi 3", "Sashi 5", "Sone 3", "Sone 5",
                    "Kami<br>Kaze", "Tsubame", "MFM", "Kirochin", "Dorufin", "Press", "Heel B<br>Compass",
                    "FS Nollie<br>Lock", "BS Nollie<br>Lock"
                ],
                title: "GROUND<br>TRICK SPIN"
            },
            ja: {
                challenger: "„ÉÅ„É£„É¨„É≥„Ç∏„É£„Éº", round: "„É©„Ç¶„É≥„Éâ", hits: ["1 „Éí„ÉÉ„Éà", "2 „Ç≥„É≥„Éú", "3 „Ç≥„É≥„Éú"],
                ready: "Ê∫ñÂÇô„ÅØ„ÅÑ„ÅÑÔºü", press_spin: "„Çπ„Éî„É≥„ÇíÊäº„Åó„Å¶", start: "„Çπ„Çø„Éº„Éà",
                complete: "„Éà„É™„ÉÉ„ÇØÂÆå‰∫ÜÔºÅ", confirm: "Á¢∫ÂÆö„Åô„Çã", ranking: "ÊúÄÁµÇ„É©„É≥„Ç≠„É≥„Ç∞",
                again: "„ÇÇ„ÅÜ‰∏ÄÂ∫¶", next: "Ê¨°„ÅØ...", ready_btn: "Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ", rounds_label: "„É©„Ç¶„É≥„ÉâÊï∞:",
                spin_btn: "„Çπ„Éî„É≥ÈñãÂßã", status_spin: "ÊäΩÈÅ∏‰∏≠...", status_roll: "„É≠„Éº„É´‰∏≠", status_finish: "ÂÆå‰∫ÜÔºÅ",
                tricks: [
                    "FS<br>„Éé„É™„Éº3", "FS<br>„Éé„É™„Éº5", "BS<br>„Éé„É™„Éº3", "BS<br>„Éé„É™„Éº5",
                    "FS„Éé„É™„Éº<br>„Ç≥„É≥„Éë„Çπ3", "FS„Éé„É™„Éº<br>„Ç≥„É≥„Éë„Çπ5", "BS„Éé„É™„Éº<br>„Ç≥„É≥„Éë„Çπ3", "BS„Éé„É™„Éº<br>„Ç≥„É≥„Éë„Çπ5",
                    "„Éâ„É©„Ç§„Éñ<br>„Çπ„Éî„É≥5", "„Ç™„Éº„Ç¶„Çß„É≥", "„Éà„ÉÅ", "„Ç¢„É≥„Éá„Ç£3", "„Ç¢„É≥„Éá„Ç£5", "„Çµ„Ç∑3", "„Çµ„Ç∑5", "„ÇΩ„Éç3", "„ÇΩ„Éç5",
                    "„Ç´„Éü„Ç´„Çº", "ÁáïËøî„Åó", "MFM", "„Ç≠„É≠„ÉÅ„É≥", "„Éâ„É´„Éï„Ç£„É≥", "„Éó„É¨„Çπ", "„Éí„Éº„É´B<br>„Ç≥„É≥„Éë„Çπ",
                    "FS„Éé„É™„Éº<br>„É≠„ÉÉ„ÇØ", "BS„Éé„É™„Éº<br>„É≠„ÉÉ„ÇØ"
                ],
                title: "„Ç∞„É©„Éà„É™<br>„Çπ„Éî„É≥"
            }
        };

        let lang = 'en', players = [], totalRounds = 0, currentRound = 1, turnIdx = 0, isBusy = false;
        let trickBoxes = [], modeBoxes = [], curMPos = 0, curTPos = 0, sessionTricks = [], tempStars = 0;

        function changeLang(l) {
            lang = l;
            document.body.className = `lang-${l}`;
            document.getElementById('btn-en').classList.toggle('active', l === 'en');
            document.getElementById('btn-ja').classList.toggle('active', l === 'ja');
            const rt = document.getElementById('rating-text');
            const isMobile = window.innerWidth < 640;
            if (lang === 'en') { rt.style.fontSize = isMobile ? '16px' : '32px'; } 
            else { rt.style.fontSize = isMobile ? '22px' : '48px'; }
            updateStaticUI(); AudioSys.beep(); AudioSys.startMarioTheme();
        }

        function updateStaticUI() {
            const t = I18N[lang];
            document.getElementById('label-challenger').innerText = t.challenger;
            document.getElementById('label-round').innerText = t.round;
            document.getElementById('title-main').innerHTML = t.title;
            document.getElementById('label-rounds-setup').innerText = t.rounds_label;
            document.getElementById('setup-start-btn').innerText = t.start;
            document.getElementById('status-label').innerText = t.ready;
            document.getElementById('msg-display').innerText = t.press_spin;
            document.getElementById('label-complete').innerText = t.complete;
            document.getElementById('confirm-rating-btn').innerText = t.confirm;
            document.getElementById('label-ranking').innerText = t.ranking;
            document.getElementById('btn-again').innerText = t.again;
            document.getElementById('label-next').innerText = t.next;
            document.getElementById('btn-ready').innerText = t.ready_btn;
            document.getElementById('start-btn').innerText = t.spin_btn;
            [0, 1, 2].forEach(i => { document.getElementById(`mode-${i}`).innerText = t.hits[i]; });
            
            if (trickBoxes.length > 0) { renderGrid(); }
        }

        function checkInputs() { document.getElementById('setup-start-btn').disabled = (document.getElementById('p1').value.trim() === ""); }

        function setBackground(containerId, templateId) {
            const container = document.getElementById(containerId);
            const template = document.getElementById(templateId);
            if (container && template) { container.innerHTML = ''; container.appendChild(template.content.cloneNode(true)); }
        }

        function initGame() {
            const names = [document.getElementById('p1').value.trim(), document.getElementById('p2').value.trim(), document.getElementById('p3').value.trim()].filter(v => v !== "");
            totalRounds = parseInt(document.getElementById('round-select').value);
            players = names.map(name => ({ name, score: 0 }));
            document.getElementById('setup-overlay').classList.add('hidden');
            renderGrid(); updateHUD(); AudioSys.coin(); AudioSys.startMarioTheme();
        }

        function renderGrid() {
            const grid = document.getElementById('slot-grid'), colors = ['box-red', 'box-blue', 'box-green', 'box-yellow'];
            grid.querySelectorAll('.trick-box').forEach(e => e.remove());
            trickBoxes = []; const t_tricks = I18N[lang].tricks;
            GRID_PATH.forEach((pos, i) => {
                const b = document.createElement('div');
                b.className = `trick-box ${colors[i % 4]}`;
                b.style.gridRow = pos.r; b.style.gridColumn = pos.c;
                
                const inner = document.createElement('div');
                inner.className = 'trick-inner';
                inner.innerHTML = t_tricks[i % t_tricks.length];
                
                b.appendChild(inner);
                grid.appendChild(b); trickBoxes.push(b);
            });
            modeBoxes = [document.getElementById('mode-0'), document.getElementById('mode-1'), document.getElementById('mode-2')];
            
            document.querySelectorAll('.trick-inner').forEach(el => el.style.transform = 'scale(1)');
            setTimeout(fitText, 50); 
        }

        function fitText() {
            requestAnimationFrame(() => {
                document.querySelectorAll('.trick-inner').forEach(el => {
                    const parent = el.parentElement;
                    const parentW = parent.clientWidth - 4; 
                    const parentH = parent.clientHeight - 4;
                    const scrollW = el.scrollWidth;
                    const scrollH = el.scrollHeight;
                    
                    if (scrollW > parentW || scrollH > parentH) {
                        const scaleW = parentW / scrollW;
                        const scaleH = parentH / scrollH;
                        const scale = Math.min(scaleW, scaleH) * 0.95; 
                        el.style.transform = `scale(${scale})`;
                    }
                });
            });
        }

        window.addEventListener('resize', () => { 
            document.querySelectorAll('.trick-inner').forEach(el => el.style.transform = 'scale(1)');
            setTimeout(fitText, 100); 
        });

        function updateHUD() { if (players[turnIdx]) { document.getElementById('hud-name').innerText = players[turnIdx].name.toUpperCase(); document.getElementById('hud-round').innerText = `${currentRound}/${totalRounds}`; } }

        async function runSequence() {
            if (isBusy) return; isBusy = true; 
            document.getElementById('start-btn').disabled = true;
            sessionTricks = []; const t = I18N[lang];
            document.getElementById('status-label').innerText = t.status_spin;
            const modeIdx = Math.floor(Math.random() * 3);
            await marquee(modeBoxes, curMPos, modeIdx, (p) => curMPos = p, true);
            const hits = modeIdx + 1;
            for (let i = 0; i < hits; i++) {
                document.getElementById('status-label').innerText = `${t.status_roll} ${i+1}/${hits}`;
                const target = Math.floor(Math.random() * trickBoxes.length);
                await marquee(trickBoxes, curTPos, target, (p) => curTPos = p, false);
                trickBoxes[curTPos].classList.add('selected-fixed');
                
                // üî• Ê†∏ÂøÉ‰øÆÂæ©ÔºöÁ≤æÊ∫ñÊäìÂèñÊñáÂ≠óÔºåÊç®Ê£ÑÊâÄÊúâ HTML ÊéíÁâàÁ¢º
                const rawHTML = trickBoxes[curTPos].querySelector('.trick-inner').innerHTML;
                const cleanText = rawHTML.replace(/<br\s*[\/]?>/gi, " ");
                sessionTricks.push(cleanText);
                
                await new Promise(r => setTimeout(r, 800));
            }
            document.getElementById('status-label').innerText = t.status_finish;
            document.getElementById('msg-display').innerText = sessionTricks.join(" + ");
            setTimeout(() => {
                setBackground('rating-bg', 'tpl-rating');
                document.getElementById('rating-text').innerText = sessionTricks.join(" + ");
                document.getElementById('rating-overlay').classList.remove('hidden');
                tempStars = 0; resetStars(); AudioSys.win();
            }, 1000);
        }

        function marquee(elements, startPos, targetIdx, updatePos, isMode) {
            return new Promise(resolve => {
                const distance = (targetIdx - startPos + elements.length) % elements.length;
                const minRotations = isMode ? 2 : 3;
                let steps = (elements.length * minRotations) + distance; 
                let count = 0, speed = 40, pos = startPos;
                function tick() {
                    elements[pos].classList.remove('active');
                    pos = (pos + 1) % elements.length;
                    elements[pos].classList.add('active'); AudioSys.beep();
                    count++;
                    if (count < steps) {
                        if (steps - count < 12) speed += 40;
                        else if (steps - count < 25) speed += 15;
                        setTimeout(tick, speed);
                    } else {
                        if (isMode) { elements[pos].classList.remove('active'); elements[pos].classList.add('selected-fixed'); }
                        updatePos(pos); AudioSys.boop(); resolve();
                    }
                }
                tick();
            });
        }

        function setStars(val) {
            tempStars = val; document.querySelectorAll('.star-icon').forEach((s, i) => s.classList.toggle('active', i < val));
            document.getElementById('confirm-rating-btn').disabled = false; AudioSys.beep();
        }

        function resetStars() { document.querySelectorAll('.star-icon').forEach(s => s.classList.remove('active')); document.getElementById('confirm-rating-btn').disabled = true; }

        function saveRating() {
            players[turnIdx].score += tempStars; document.getElementById('rating-overlay').classList.add('hidden');
            turnIdx++; if (turnIdx >= players.length) { turnIdx = 0; currentRound++; }
            if (currentRound > totalRounds) { setBackground('ranking-bg', 'tpl-ranking'); showRankings(); } 
            else { setBackground('turn-bg', 'tpl-turn'); document.getElementById('next-name').innerText = players[turnIdx].name; document.getElementById('turn-overlay').classList.remove('hidden'); }
            AudioSys.coin();
        }

        function closeTurn() {
            document.getElementById('turn-overlay').classList.add('hidden');
            modeBoxes.forEach(e => e.classList.remove('active', 'selected-fixed'));
            trickBoxes.forEach(e => e.classList.remove('active', 'selected-fixed'));
            updateHUD(); 
            isBusy = false; 
            document.getElementById('start-btn').disabled = false;
            document.getElementById('msg-display').innerText = I18N[lang].press_spin;
            document.getElementById('status-label').innerText = I18N[lang].ready; AudioSys.beep();
        }

        function showRankings() {
            const sorted = [...players].sort((a, b) => b.score - a.score);
            let html = `<table class="leaderboard"><thead><tr><th>RANK</th><th>NAME</th><th>STARS</th></tr></thead><tbody>`;
            sorted.forEach((p, i) => { html += `<tr><td>${i+1}</td><td>${p.name.toUpperCase()}</td><td>${'‚òÖ'.repeat(p.score)} (${p.score})</td></tr>`; });
            html += '</tbody></table>';
            document.getElementById('rank-container').innerHTML = html;
            document.getElementById('ranking-overlay').classList.remove('hidden'); AudioSys.win();
        }

        setBackground('setup-bg', 'tpl-home'); changeLang('en');
    </script>
</body>
</html>