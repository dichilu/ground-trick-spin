<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ground Trick Spin - v1.8.5 Polished</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Dela+Gothic+One&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --mario-red: #e4000f;
            --mario-blue: #049cd8;
            --mario-yellow: #fbd000;
            --mario-green: #43b047;
            --mario-brown: #8d5524;
            --mario-sky: #5c94fc;
            --brick-orange: #f08c3b;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #000;
            color: white;
            image-rendering: pixelated;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 5px;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* 日文版使用 Dela Gothic One */
        body.lang-ja {
            font-family: 'Dela Gothic One', cursive;
        }

        /* 強制移除所有陰影 */
        * {
            text-shadow: none !important;
            box-shadow: none !important;
            outline: none !important;
            box-sizing: border-box;
        }

        .cabinet {
            background: #5d3a37;
            border: 10px solid #221111;
            padding: 15px;
            width: 100%;
            max-width: 850px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        @media (min-width: 640px) {
            .cabinet { padding: 25px; border-width: 12px; }
        }

        .screen-bezel {
            background: #111;
            padding: 10px;
            border: 4px solid #000;
            border-radius: 10px;
            position: relative;
            z-index: 5;
        }

        @media (min-width: 640px) {
            .screen-bezel { padding: 20px; border-width: 8px; }
        }

        /* 標題設計：黑字配黃色超粗描邊 (直接浮動於背景) */
        .mario-title-text {
            color: #000 !important;
            -webkit-text-stroke: 6px var(--mario-yellow);
            paint-order: stroke fill;
            letter-spacing: 2px;
            line-height: 1.4;
            text-align: center;
            font-weight: 900;
            margin-bottom: 30px;
            display: inline-block;
        }

        #title-main { font-size: 28px; }
        body.lang-ja #title-main { 
            font-size: 40px; 
            -webkit-text-stroke: 6px var(--mario-yellow);
            letter-spacing: 0px;
        }

        /* 日文版標題文字放大幅度 */
        body.lang-ja #label-complete, 
        body.lang-ja #label-ranking {
            font-size: 32px;
            -webkit-text-stroke: 6px var(--mario-yellow);
        }

        @media (min-width: 640px) {
            #title-main { font-size: 60px; -webkit-text-stroke: 12px var(--mario-yellow); }
            body.lang-ja #title-main { font-size: 70px; -webkit-text-stroke: 10px var(--mario-yellow); }
            
            body.lang-ja #label-complete, 
            body.lang-ja #label-ranking {
                font-size: 60px;
                -webkit-text-stroke: 10px var(--mario-yellow);
            }
        }

        /* 按鈕視覺系統 */
        .btn-arcade {
            background: var(--mario-red);
            border: 6px solid #000;
            color: white;
            padding: 20px 10px; /* 增加左右留白 */
            width: 100%;
            cursor: pointer;
            font-size: 20px;
            margin-top: 20px;
            position: relative;
            z-index: 10;
        }
        .btn-arcade:active { transform: translateY(6px); }

        /* --- 新增：按鈕被禁用時的樣式 (變成灰色且無法點擊) --- */
        .btn-arcade:disabled {
            background: #555 !important;
            color: #aaa !important;
            border-color: #333 !important;
            cursor: not-allowed;
            transform: none !important;
        }

        /* 日文版按鈕比例調整 */
        body.lang-ja .btn-arcade {
            font-size: 24px;
            padding: 24px 10px;
        }

        @media (min-width: 640px) {
            body.lang-ja .btn-arcade {
                font-size: 36px;
                padding: 30px 15px;
            }
        }

        /* 版號資訊字體樣式 (置於按鈕下方) */
        .ver-info-text {
            margin-top: 8px;
            font-size: 8px;
            color: rgba(255, 255, 255, 0.4);
            font-family: sans-serif;
            text-align: center;
            width: 100%;
            display: block;
        }

        /* 語言切換：純文字無框 */
        .btn-lang {
            background: transparent !important;
            border: none !important;
            color: #fff;
            padding: 10px 20px;
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }

        @media (min-width: 640px) {
            .btn-lang { font-size: 28px; }
        }

        .btn-lang.active { color: var(--mario-yellow) !important; text-decoration: underline; }

        /* 轉盤格子與排版 */
        .top-marquee {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            background: #000;
            padding: 10px;
            border: 3px solid var(--mario-brown);
        }

        .mode-box {
            background: #1a1a1a;
            border: 3px solid #444;
            height: 65px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #666;
            text-align: center;
            padding: 4px 8px; /* 增加內部留白，字不貼邊 */
        }
        
        body.lang-ja .mode-box { font-size: 18px; }

        @media (min-width: 640px) {
            .mode-box { height: 85px; font-size: 14px; border-width: 4px; padding: 6px 12px; }
            body.lang-ja .mode-box { font-size: 28px; }
        }

        .mode-box.active { background: #fff !important; color: #000 !important; z-index: 10; }
        .mode-box.selected-fixed { background: var(--mario-blue) !important; color: #fff !important; border-color: #fff !important; }

        .slot-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 4px;
            background: #000;
            padding: 6px;
            border: 2px solid #333;
        }

        .trick-box {
            height: 48px;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6px;
            color: #fff;
            text-align: center;
            padding: 4px; /* 增加內部留白，文字不貼邊 */
            line-height: 1.2; /* 增加行距提升呼吸感 */
            word-wrap: break-word; /* 優化斷行邏輯 */
            overflow: hidden;
        }

        @media (min-width: 640px) {
            .trick-box { height: 80px; font-size: 9px; padding: 8px; }
            body.lang-ja .trick-box { font-size: 16px; line-height: 1.2; }
        }

        body.lang-ja .trick-box { font-size: 10px; }

        .box-red { background: #8a0009; }
        .box-blue { background: #02668d; }
        .box-green { background: #266b29; }
        .box-yellow { background: var(--mario-yellow); color: #000; }

        .trick-box.active { background: #fff !important; color: #000 !important; transform: scale(1.08); z-index: 100; }
        .trick-box.selected-fixed { background: #fff !important; color: #000 !important; border: 4px solid var(--mario-yellow) !important; }

        /* 中央畫面 */
        .center-screen {
            grid-column: 2 / 8;
            grid-row: 2 / 5;
            background: var(--mario-sky);
            border: 4px solid #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        /* HUD */
        .led-panel {
            font-family: 'Press Start 2P', cursive;
            background: #000;
            border: 4px solid #555;
            padding: 10px;
            color: #fff;
            text-align: center;
        }
        body.lang-ja .led-panel { font-family: 'Dela Gothic One', cursive; }
        #hud-name { font-size: 14px; min-width: 120px; }
        @media (min-width: 640px) { #hud-name { font-size: 24px; min-width: 200px; } }

        /* Overlays */
        .overlay {
            position: absolute; inset: 0; 
            z-index: 500; padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hidden { display: none !important; }

        input, select {
            background: #000 !important;
            border: 4px solid #fff !important; 
            color: var(--mario-yellow) !important;
            padding: 15px; 
            font-size: 12px; 
            width: 100%; 
            outline: none; 
            margin-bottom: 15px;
            text-align: center;
            appearance: none;
            -webkit-appearance: none;
            border-radius: 0;
        }
        body.lang-ja input, body.lang-ja select { font-size: 18px; }

        .star-rating { display: flex; gap: 10px; margin: 25px 0; z-index: 10; }
        .star-icon { font-size: 40px; color: #111; cursor: pointer; }
        @media (min-width: 640px) { .star-icon { font-size: 60px; } }
        .star-icon.active { color: var(--mario-yellow); }

        /* 排行榜排版修正：日文版縮小字體防止溢出 */
        .leaderboard { 
            width: 100%; border-collapse: collapse; margin-top: 20px; 
            font-size: 10px; color: #fff; background: rgba(0,0,0,0.9);
            z-index: 10;
        }
        body.lang-ja .leaderboard { 
            font-size: 14px; 
        }
        @media (min-width: 640px) {
            body.lang-ja .leaderboard { font-size: 18px; }
        }
        .leaderboard th, .leaderboard td { border: 2px solid #fff; padding: 10px; text-align: center; }

        .scene-bg { position: absolute; inset: 0; pointer-events: none; z-index: 0; }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        .float-obj { animation: float 2.5s ease-in-out infinite; }
    </style>
</head>
<body class="lang-en">

    <!-- 背景圖層模板 -->
    <template id="tpl-home">
        <svg width="100%" height="100%" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="200" fill="#5c94fc"/>
            <polygon points="0,200 60,80 120,200" fill="#fff" opacity="0.4"/>
            <polygon points="50,200 130,50 210,200" fill="#fff" opacity="0.9"/>
            <rect x="30" y="160" width="40" height="40" fill="#00a000" stroke="#000" stroke-width="2"/>
            <rect x="22" y="150" width="56" height="15" fill="#00a000" stroke="#000" stroke-width="2"/>
            <rect y="190" width="200" height="10" fill="#f08c3b" stroke="#000" stroke-width="2"/>
        </svg>
    </template>

    <template id="tpl-rating">
        <svg width="100%" height="100%" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid slice">
            <rect width="200" height="200" fill="#5c94fc"/>
            <path d="M0,175 Q100,145 200,175 V200 H0 Z" fill="#fff"/>
            <circle cx="160" cy="50" r="22" fill="#fbd000" opacity="0.6"/>
            <path d="M10,175 L40,200 M70,175 L100,200 M130,175 L160,200" stroke="#ddd" stroke-width="6" stroke-dasharray="10,10"/>
        </svg>
    </template>

    <template id="tpl-ranking">
        <svg width="100%" height="100%" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid slice">
            <rect width="200" height="200" fill="#5c94fc"/>
            <rect x="10" y="185" width="180" height="15" fill="#f08c3b" stroke="#000" stroke-width="2"/>
            <rect x="70" y="125" width="60" height="60" fill="#049cd8" stroke="#000" stroke-width="3"/>
            <rect x="30" y="150" width="40" height="35" fill="#43b047" stroke="#000" stroke-width="3"/>
            <rect x="130" y="160" width="40" height="25" fill="#e4000f" stroke="#000" stroke-width="3"/>
        </svg>
    </template>

    <template id="tpl-turn">
        <svg width="100%" height="100%" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid slice">
            <rect width="200" height="200" fill="#049cd8"/>
            <rect width="200" height="200" fill="url(#grid)" opacity="0.25" />
            <defs>
                <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="white" stroke-width="1.5"/>
                </pattern>
            </defs>
        </svg>
    </template>

    <div class="cabinet">
        <!-- HUD -->
        <div class="flex justify-between mb-4 px-2 items-end">
            <div>
                <p id="label-challenger" class="text-[8px] text-gray-400 mb-1 uppercase font-bold">CHALLENGER</p>
                <div id="hud-name" class="led-panel">---</div>
            </div>
            <div class="text-right">
                <p id="label-round" class="text-[8px] text-gray-400 mb-1 uppercase font-bold">ROUND</p>
                <div id="hud-round" class="led-panel text-yellow-400">0/0</div>
            </div>
        </div>

        <div class="screen-bezel">
            <div class="top-marquee">
                <div id="mode-0" class="mode-box">1 HIT</div>
                <div id="mode-1" class="mode-box">2 COMBO</div>
                <div id="mode-2" class="mode-box">3 COMBO</div>
            </div>

            <div id="slot-grid" class="slot-grid">
                <div class="center-screen">
                    <div class="absolute inset-0 z-0">
                        <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
                            <polygon points="0,100 35,45 70,100" fill="#cbd5e1" />
                            <polygon points="45,100 75,25 105,100" fill="#94a3b8" />
                        </svg>
                    </div>
                    
                    <div id="mario-ski" class="mb-4 relative z-10 float-obj">
                        <svg width="100" height="100" viewBox="0 0 16 16">
                            <rect x="1" y="14" width="14" height="2" fill="#000"/>
                            <rect x="2" y="13" width="12" height="2" fill="#FF0000"/>
                            <rect x="5" y="10" width="3" height="3" fill="#0000FF"/>
                            <rect x="9" y="10" width="3" height="3" fill="#0000FF"/>
                            <rect x="6" y="6" width="6" height="5" fill="#FF0000"/>
                            <rect x="3" y="9" width="3" height="1" fill="#FFDBAC"/>
                            <rect x="11" y="8" width="3" height="1" fill="#FFDBAC"/>
                            <rect x="7" y="2" width="5" height="4" fill="#FFDBAC"/>
                            <rect x="7" y="1" width="6" height="1" fill="#FF0000"/> 
                            <rect x="11" y="3" width="1" height="1" fill="#000"/>
                            <rect x="0" y="14" width="2" height="1" fill="#fff" opacity="0.6"/>
                            <rect x="14" y="14" width="2" height="1" fill="#fff" opacity="0.6"/>
                        </svg>
                    </div>

                    <div class="relative z-20 w-5/6 text-center">
                        <div id="status-label" class="text-[8px] text-white mb-2 uppercase font-bold">READY?</div>
                        <div class="bg-black/95 border-4 border-white p-3 shadow-xl">
                            <p id="msg-display" class="text-[8px] text-yellow-400 uppercase font-bold">PRESS SPIN</p>
                        </div>
                    </div>
                    <div class="snow-ground"></div>
                </div>
            </div>
        </div>

        <button id="start-btn" onclick="runSequence()" class="btn-arcade">SPIN START</button>
        <!-- 轉盤頁面版號 -->
        <div class="ver-info-text">v1.8.5 Polished</div>

        <!-- SETUP OVERLAY (HOME) -->
        <div id="setup-overlay" class="overlay">
            <div class="scene-bg" id="setup-bg"></div>
            <div class="absolute top-4 flex gap-8 z-[600]">
                <button onclick="changeLang('en')" id="btn-en" class="btn-lang active">ENGLISH</button>
                <button onclick="changeLang('ja')" id="btn-ja" class="btn-lang">日本語</button>
            </div>
            <div class="relative z-10 w-full max-w-lg flex flex-col items-center">
                <h1 id="title-main" class="mario-title-text uppercase font-black">GROUND<br>TRICK SPIN</h1>
                
                <div class="w-full px-5">
                    <input type="text" id="p1" placeholder="NAME 1 (REQUIRED)" oninput="checkInputs()">
                    <input type="text" id="p2" placeholder="NAME 2 (OPTIONAL)" oninput="checkInputs()">
                    <input type="text" id="p3" placeholder="NAME 3 (OPTIONAL)" oninput="checkInputs()">
                    <div class="flex items-center justify-between w-full mt-2 bg-black border-4 border-white p-4">
                        <span id="label-rounds-setup" class="text-[10px] text-white uppercase font-bold">ROUNDS:</span>
                        <select id="round-select" class="w-24 text-[12px] !m-0 !p-1 !bg-transparent border-0">
                            <option value="1">1</option><option value="2">2</option>
                            <option value="3" selected>3</option><option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
                <!-- 預設按鈕為 disabled 狀態 -->
                <button id="setup-start-btn" disabled onclick="initGame()" class="btn-arcade mt-8 w-11/12 text-[16px]">START CHALLENGE</button>
                <!-- 首頁版號 -->
                <div class="ver-info-text">v1.8.5 Polished</div>
            </div>
        </div>

        <!-- RATING OVERLAY -->
        <div id="rating-overlay" class="overlay hidden rating-panel">
            <div class="scene-bg" id="rating-bg"></div>
            <div class="relative z-10 flex flex-col items-center w-full">
                <h3 id="label-complete" class="mario-title-text text-xl uppercase font-bold">TRICK COMPLETE!</h3>
                <p id="rating-text" class="text-white text-center mb-10 uppercase font-black"></p>
                <div class="star-rating">
                    <span class="star-icon" onclick="setStars(1)">★</span>
                    <span class="star-icon" onclick="setStars(2)">★</span>
                    <span class="star-icon" onclick="setStars(3)">★</span>
                    <span class="star-icon" onclick="setStars(4)">★</span>
                    <span class="star-icon" onclick="setStars(5)">★</span>
                </div>
                <button id="confirm-rating-btn" disabled onclick="saveRating()" class="btn-arcade text-[18px] w-3/4">CONFIRM STARS</button>
                <!-- 評分頁版號 -->
                <div class="ver-info-text">v1.8.5 Polished</div>
            </div>
        </div>

        <!-- RANKING OVERLAY -->
        <div id="ranking-overlay" class="overlay hidden ranking-panel">
            <div class="scene-bg" id="ranking-bg"></div>
            <div class="relative z-10 flex flex-col items-center w-full max-w-xl">
                <div class="mb-8 float-obj">
                    <svg width="220" height="220" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4" y="2" width="8" height="7" fill="#fbd000" stroke="#000" stroke-width="0.5"/>
                        <rect x="2" y="3" width="2" height="5" fill="#fbd000" stroke="#000" stroke-width="0.5"/>
                        <rect x="12" y="3" width="2" height="5" fill="#fbd000" stroke="#000" stroke-width="0.5"/>
                        <rect x="7" y="9" width="2" height="3" fill="#fbd000" stroke="#000" stroke-width="0.5"/>
                        <rect x="5" y="12" width="6" height="2" fill="#fbd000" stroke="#000" stroke-width="0.5"/>
                        <rect x="7" y="4" width="2" height="2" fill="#fff" opacity="0.8"/>
                    </svg>
                </div>
                <h2 id="label-ranking" class="mario-title-text text-xl uppercase font-black">FINAL RANKING</h2>
                <div id="rank-container" class="w-full"></div>
                <button id="btn-again" onclick="location.reload()" class="btn-arcade mt-12 text-[14px] w-2/3">PLAY AGAIN</button>
                <!-- 排名頁版號 -->
                <div class="ver-info-text">v1.8.5 Polished</div>
            </div>
        </div>

        <!-- TURN OVERLAY -->
        <div id="turn-overlay" class="overlay hidden">
            <div class="scene-bg" id="turn-bg"></div>
            <div class="relative z-10 flex flex-col items-center">
                <p id="label-next" class="text-yellow-400 mb-8 text-xl text-center uppercase font-bold">UP NEXT</p>
                <p id="next-name" class="text-4xl text-white mb-16 text-center uppercase font-bold"></p>
                <button id="btn-ready" onclick="closeTurn()" class="btn-arcade text-[18px] w-full">I AM READY!</button>
                <!-- 換人頁版號 -->
                <div class="ver-info-text">v1.8.5 Polished</div>
            </div>
        </div>
    </div>

    <script>
        const AudioSys = {
            ctx: null, bgmTimer: null,
            init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            play(freq, type, duration, vol=0.1) {
                this.init();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type === 'bgm' ? 'triangle' : type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },
            beep() { this.play(880, 'square', 0.1); },
            boop() { this.play(220, 'square', 0.15); },
            coin() { this.play(987, 'square', 0.1); setTimeout(() => this.play(1318, 'square', 0.3), 100); },
            win() { 
                const notes = [523, 659, 783, 1046];
                notes.forEach((f, i) => setTimeout(() => this.play(f, 'square', 0.2), i * 150));
            },
            startMarioTheme() {
                if(this.bgmTimer) return; this.init();
                const theme = [{f:659, d:150}, {f:659, d:150}, {f:0, d:150}, {f:659, d:150}, {f:0, d:150}, {f:523, d:150}, {f:659, d:150}, {f:0, d:150}, {f:783, d:300}, {f:0, d:300}, {f:392, d:300}, {f:0, d:300}];
                let idx = 0;
                const playNext = () => {
                    const note = theme[idx];
                    if(note.f > 0) this.play(note.f, 'bgm', note.d/1000, 0.05);
                    idx = (idx + 1) % theme.length;
                    this.bgmTimer = setTimeout(playNext, note.d);
                };
                playNext();
            }
        };

        const GRID_PATH = [
            {r:1, c:1}, {r:1, c:2}, {r:1, c:3}, {r:1, c:4}, {r:1, c:5}, {r:1, c:6}, {r:1, c:7}, {r:1, c:8},
            {r:2, c:8}, {r:3, c:8}, {r:4, c:8}, {r:5, c:8},
            {r:5, c:7}, {r:5, c:6}, {r:5, c:5}, {r:5, c:4}, {r:5, c:3}, {r:5, c:2}, {r:5, c:1},
            {r:4, c:1}, {r:3, c:1}, {r:2, c:1}
        ];

        const I18N = {
            en: {
                challenger: "CHALLENGER", round: "ROUND", hits: ["1 HIT", "2 COMBO", "3 COMBO"],
                ready: "READY?", press_spin: "PRESS SPIN", start: "START CHALLENGE",
                complete: "TRICK COMPLETE!", confirm: "CONFIRM STARS", ranking: "FINAL RANKING",
                again: "PLAY AGAIN", next: "UP NEXT", ready_btn: "I AM READY!", rounds_label: "ROUNDS:",
                spin_btn: "SPIN START", status_spin: "MODE SPIN...", status_roll: "ROLLING", status_finish: "FINISH!",
                tricks: ["FS Nollie3", "FS Nollie5", "BS Nollie3", "BS Nollie5", "FS Nollie Compass3", "FS Nollie Compass5", "BS Nollie Compass3", "BS Nollie Compass5", "Drive Spin5", "Owen", "Tochi", "Andy3", "Andy5", "Sashi3", "Sashi5", "Sone3", "Sone5", "KamiKaze", "Tsubame", "MFM", "Kirochin", "Dorufin", "Press", "Heel B Compass"],
                title: "GROUND<br>TRICK SPIN"
            },
            ja: {
                challenger: "チャレンジャー", round: "ラウンド", hits: ["1 ヒット", "2 コンボ", "3 コンボ"],
                ready: "準備はいい？", press_spin: "スピンを押して", start: "スタート",
                complete: "トリック完了！", confirm: "確定する", ranking: "最終ランキング",
                again: "もう一度", next: "次は...", ready_btn: "準備完了！", rounds_label: "ラウンド数:",
                spin_btn: "スピン開始", status_spin: "抽選中...", status_roll: "ロール中", status_finish: "完了！",
                tricks: ["FS ノリー 360", "FS ノリー 540", "BS ノリー 360", "BS ノリー 540", "FS ノリー コンパス 360", "FS ノリー コンパス 540", "BS ノリー コンパス 360", "BS ノリー コンパス 540", "ドライブ スピン 540", "オーウェン", "トチ", "アンディ 360", "アンディ 540", "サシ 360", "サシ 540", "ソネ 360", "ソネ 540", "カミカゼ", "燕返し", "MFM", "キロチン", "ドルフィン", "プレス", "ヒール B コンパス"],
                title: "グラトリ<br>スピン"
            }
        };

        let lang = 'en', players = [], totalRounds = 0, currentRound = 1, turnIdx = 0, isBusy = false;
        let trickBoxes = [], modeBoxes = [], curMPos = 0, curTPos = 0, sessionTricks = [], tempStars = 0;

        function changeLang(l) {
            lang = l;
            document.body.className = `lang-${l}`;
            document.getElementById('btn-en').classList.toggle('active', l === 'en');
            document.getElementById('btn-ja').classList.toggle('active', l === 'ja');
            const rt = document.getElementById('rating-text');
            const isMobile = window.innerWidth < 640;
            if (lang === 'en') { rt.style.fontSize = isMobile ? '16px' : '32px'; } 
            else { rt.style.fontSize = isMobile ? '22px' : '48px'; }
            updateStaticUI(); AudioSys.beep(); AudioSys.startMarioTheme();
        }

        function updateStaticUI() {
            const t = I18N[lang];
            document.getElementById('label-challenger').innerText = t.challenger;
            document.getElementById('label-round').innerText = t.round;
            document.getElementById('title-main').innerHTML = t.title;
            document.getElementById('label-rounds-setup').innerText = t.rounds_label;
            document.getElementById('setup-start-btn').innerText = t.start;
            document.getElementById('status-label').innerText = t.ready;
            document.getElementById('msg-display').innerText = t.press_spin;
            document.getElementById('label-complete').innerText = t.complete;
            document.getElementById('confirm-rating-btn').innerText = t.confirm;
            document.getElementById('label-ranking').innerText = t.ranking;
            document.getElementById('btn-again').innerText = t.again;
            document.getElementById('label-next').innerText = t.next;
            document.getElementById('btn-ready').innerText = t.ready_btn;
            document.getElementById('start-btn').innerText = t.spin_btn;
            [0, 1, 2].forEach(i => { document.getElementById(`mode-${i}`).innerText = t.hits[i]; });
            if (trickBoxes.length > 0) {
                trickBoxes.forEach((box, i) => { box.innerText = t.tricks[i % t.tricks.length]; });
            }
        }

        function checkInputs() { document.getElementById('setup-start-btn').disabled = (document.getElementById('p1').value.trim() === ""); }

        function setBackground(containerId, templateId) {
            const container = document.getElementById(containerId);
            const template = document.getElementById(templateId);
            if (container && template) {
                container.innerHTML = ''; container.appendChild(template.content.cloneNode(true));
            }
        }

        function initGame() {
            const names = [document.getElementById('p1').value.trim(), document.getElementById('p2').value.trim(), document.getElementById('p3').value.trim()].filter(v => v !== "");
            totalRounds = parseInt(document.getElementById('round-select').value);
            players = names.map(name => ({ name, score: 0 }));
            document.getElementById('setup-overlay').classList.add('hidden');
            renderGrid(); updateHUD(); AudioSys.coin(); AudioSys.startMarioTheme();
        }

        function renderGrid() {
            const grid = document.getElementById('slot-grid'), colors = ['box-red', 'box-blue', 'box-green', 'box-yellow'];
            grid.querySelectorAll('.trick-box').forEach(e => e.remove());
            trickBoxes = []; const t_tricks = I18N[lang].tricks;
            GRID_PATH.forEach((pos, i) => {
                const b = document.createElement('div');
                b.className = `trick-box ${colors[i % 4]}`;
                b.style.gridRow = pos.r; b.style.gridColumn = pos.c;
                b.innerText = t_tricks[i % t_tricks.length];
                grid.appendChild(b); trickBoxes.push(b);
            });
            modeBoxes = [document.getElementById('mode-0'), document.getElementById('mode-1'), document.getElementById('mode-2')];
            updateStaticUI();
        }

        function updateHUD() { if (players[turnIdx]) { document.getElementById('hud-name').innerText = players[turnIdx].name.toUpperCase(); document.getElementById('hud-round').innerText = `${currentRound}/${totalRounds}`; } }

        async function runSequence() {
            if (isBusy) return; isBusy = true; 
            // 這裡將按鈕設為禁用，觸發灰色 CSS
            document.getElementById('start-btn').disabled = true;
            sessionTricks = []; const t = I18N[lang];
            document.getElementById('status-label').innerText = t.status_spin;
            const modeIdx = Math.floor(Math.random() * 3);
            await marquee(modeBoxes, curMPos, modeIdx, (p) => curMPos = p, true);
            const hits = modeIdx + 1;
            for (let i = 0; i < hits; i++) {
                document.getElementById('status-label').innerText = `${t.status_roll} ${i+1}/${hits}`;
                const target = Math.floor(Math.random() * trickBoxes.length);
                await marquee(trickBoxes, curTPos, target, (p) => curTPos = p, false);
                trickBoxes[curTPos].classList.add('selected-fixed');
                sessionTricks.push(trickBoxes[curTPos].innerText);
                await new Promise(r => setTimeout(r, 800));
            }
            document.getElementById('status-label').innerText = t.status_finish;
            document.getElementById('msg-display').innerText = sessionTricks.join(" + ");
            setTimeout(() => {
                setBackground('rating-bg', 'tpl-rating');
                document.getElementById('rating-text').innerText = sessionTricks.join(" + ");
                document.getElementById('rating-overlay').classList.remove('hidden');
                tempStars = 0; resetStars(); AudioSys.win();
            }, 1000);
        }

        function marquee(elements, startPos, targetIdx, updatePos, isMode) {
            return new Promise(resolve => {
                const distance = (targetIdx - startPos + elements.length) % elements.length;
                const minRotations = isMode ? 2 : 3;
                let steps = (elements.length * minRotations) + distance; 
                let count = 0, speed = 40, pos = startPos;
                function tick() {
                    elements[pos].classList.remove('active');
                    pos = (pos + 1) % elements.length;
                    elements[pos].classList.add('active'); AudioSys.beep();
                    count++;
                    if (count < steps) {
                        if (steps - count < 12) speed += 40;
                        else if (steps - count < 25) speed += 15;
                        setTimeout(tick, speed);
                    } else {
                        if (isMode) { elements[pos].classList.remove('active'); elements[pos].classList.add('selected-fixed'); }
                        updatePos(pos); AudioSys.boop(); resolve();
                    }
                }
                tick();
            });
        }

        function setStars(val) {
            tempStars = val; document.querySelectorAll('.star-icon').forEach((s, i) => s.classList.toggle('active', i < val));
            document.getElementById('confirm-rating-btn').disabled = false; AudioSys.beep();
        }

        function resetStars() { document.querySelectorAll('.star-icon').forEach(s => s.classList.remove('active')); document.getElementById('confirm-rating-btn').disabled = true; }

        function saveRating() {
            players[turnIdx].score += tempStars; document.getElementById('rating-overlay').classList.add('hidden');
            turnIdx++; if (turnIdx >= players.length) { turnIdx = 0; currentRound++; }
            if (currentRound > totalRounds) { setBackground('ranking-bg', 'tpl-ranking'); showRankings(); } 
            else { setBackground('turn-bg', 'tpl-turn'); document.getElementById('next-name').innerText = players[turnIdx].name; document.getElementById('turn-overlay').classList.remove('hidden'); }
            AudioSys.coin();
        }

        function closeTurn() {
            document.getElementById('turn-overlay').classList.add('hidden');
            modeBoxes.forEach(e => e.classList.remove('active', 'selected-fixed'));
            trickBoxes.forEach(e => e.classList.remove('active', 'selected-fixed'));
            updateHUD(); 
            isBusy = false; 
            // 恢復按鈕可點擊狀態，顏色變回紅色
            document.getElementById('start-btn').disabled = false;
            document.getElementById('msg-display').innerText = I18N[lang].press_spin;
            document.getElementById('status-label').innerText = I18N[lang].ready; AudioSys.beep();
        }

        function showRankings() {
            const sorted = [...players].sort((a, b) => b.score - a.score);
            let html = `<table class="leaderboard"><thead><tr><th>RANK</th><th>NAME</th><th>STARS</th></tr></thead><tbody>`;
            sorted.forEach((p, i) => { html += `<tr><td>${i+1}</td><td>${p.name.toUpperCase()}</td><td>${'★'.repeat(p.score)} (${p.score})</td></tr>`; });
            html += '</tbody></table>';
            document.getElementById('rank-container').innerHTML = html;
            document.getElementById('ranking-overlay').classList.remove('hidden'); AudioSys.win();
        }

        setBackground('setup-bg', 'tpl-home'); changeLang('en');
        window.addEventListener('resize', () => changeLang(lang));
    </script>
</body>
</html>